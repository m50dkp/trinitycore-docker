#!/bin/bash

set -euo pipefail
set -x

LATEST_RELEASE_TAG=$(tc-latest-release)

# Cloning via --filter=tree:0 results in significantly less disk space used, and
# is generally faster. See
# https://github.blog/2020-12-21-get-up-to-speed-with-partial-clone-and-shallow-clone/
# for more details. Note: --filter=tree:0 was generally faster on the operations
# needed here and smaller repo size than --filter=blob:none.

[ -d "/hostfs/tc-server/source/.git" ] && {
  # Update if repo exists
  cd /hostfs/tc-server/source
  git fetch --tags
  git checkout $LATEST_RELEASE_TAG
  exit 0
} || {
  # Clone if fresh
  git clone \
    --filter=tree:0 \
    -b $LATEST_RELEASE_TAG \
    git://github.com/TrinityCore/TrinityCore.git \
    /hostfs/tc-server/source
  exit 0
}
