#!/bin/bash

set -euo pipefail
set -x

# This script does the build without copying the source or build folders in/out.
# This is useful on linux, where docker file operations are nearly transparent.
# On MacOS, file operations are slower, and result in the build taking at least
# 2x longer.

cd /hostfs/tc-server/source

mkdir -p build
cd build
cmake ../ -DCMAKE_INSTALL_PREFIX=/hostfs/tc-server/dist
make -j $(nproc)
make install

# copy out the conf files for easy comparison
rsync \
  --compress-level=0 \
  -arhW \
  --info=progress2 \
  /hostfs/tc-server/dist/etc/* /hostfs/tc-conf/