name: Build & Smoke Test TrinityCore-Docker

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  build-smoke-test:
    runs-on: ubuntu-latest

    steps:
      - name: Login to Docker Hub for private images
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Use node.js 14
        uses: actions/setup-node@v1
        with:
          node-version: 14

      - name: Get TrinityCore source
        run: ./action tc-fetch

      - name: Cache / Retrieve pre-built TrinityCore
        uses: actions/cache@v2
        env:
          cache-name: trinitycore-build-cache
        with:
          # npm cache files are stored in `~/.npm` on Linux/macOS
          path: containerfs/tc-server/source/build
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('./containerfs/tc-server/source/.git/HEAD') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-

      - name: Build TrinityCore
        run: ./action tc-build

      - name: Get DB
        run: ./action tc-db-fetch

      - name: Prepare maps
        run: ./ci/copy-maps-from-image

      - name: Boot services
        run: docker-compose up -d

      - name: Wait for final service (authserver)
        run: /bin/sh -c 'until curl -s "http://localhost:7777"; do sleep 1; done;'

      - name: Shutdown services
        run: docker-compose down

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v1
        with:
          name: TrinityCore Logs
          path: ./containerfs/tc-wd/*.log